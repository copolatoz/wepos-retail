/**
 * Filename: audit_closing.controller.closingPurchasing.js
 * Generated 2018-09-04 at 08:57:40 PM
 */
Ext.define('ExtApp.modules.audit_closing.controller.closingPurchasing',{extend:'ExtApp.core.Module',id:'modules.audit_closing.closingPurchasing',isloadModuleStore:true,suspendIfLoadStore:true,generate_total_hari:0,generate_current_total:0,init:function(){this.launcher={text:'Closing Purchasing',iconCls:'icon-grid'};},useHelper:[],ModuleStore:{'audit_closing':[{store_name:'store_closingPurchasing',autoload:false},{store_name:'store_closingPurchasingDetail',autoload:false}]},ModuleModel:{'audit_closing':[{model_name:'model_closingPurchasing'},{model_name:'model_closingPurchasingDetail'}]},createWindow:function(me,winID,winFunc){var me=this;var win_func='openWindow';if(winFunc){win_func=winFunc;}
var win_id=me.id;if(winID){win_id=me.id+'_'+winID;if(!winFunc){win_func=winID;}}
var desktop=me.app.getDesktop();var win=me.app.getDesktop().getWindow(win_id);if(!win){me.app.createView('ExtApp.modules.audit_closing.view.closingPurchasing',me,win_func);}else{me.app.desktop.restoreWindow(win);}},doClose:function(winVar){var me=this;var win=me.app.getDesktop().getWindow(winVar);if(win){win.doClose();}},generateConfirm_closingPurchasing:function(){var me=this;if(me.closing_data.tanggal){var getSelection=Ext.getCmp('grid_closingPurchasing').getSelectionModel().selected;var selected_data={allTanggal:[],allName:''};for(x in getSelection.items){if(getSelection.items[x].data.closing_status==0){selected_data.allTanggal.push(getSelection.items[x].data.tanggal);if(selected_data.allName==''){selected_data.allName=getSelection.items[x].data.tanggal;}else{selected_data.allName+=', '+getSelection.items[x].data.tanggal;}}else{ExtApp.Msg.info("Date: "+getSelection.items[x].data.tanggal+" Been Closed!");return false;}}
ExtApp.Msg.confirm('Generate Selected Date <br/><br/><i>'+'<b>Anda yakin ?</b></i>',false,function(btn){if(btn=='yes'){me.generateCheck_closingPurchasing(selected_data);}else{return false;}});}else{ExtApp.Msg.info("Please choose date!");}},generateCheck_closingPurchasing:function(selected_data){var me=this;var theApp=me.app;if(!selected_data.allTanggal){ExtApp.Msg.info("Date undefined!");return;}
me.generate_total_hari=0;Ext.getCmp('grid_closingPurchasingDetail').setTitle('Check Date..');var phpJs=theApp.getHelper('phpJs');var myMask=new Ext.LoadMask(Ext.getCmp('grid_closingPurchasing'),{msg:"Generate Check Date..."});myMask.show();Ext.Ajax.request({waitMsg:'Checking ...',url:appUrl+'audit_closing/closingPurchasing/generate',method:'POST',params:{is_check:1,closing_date:Ext.JSON.encode(selected_data.allTanggal)},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);myMask.hide();return;}else{myMask.hide();}
if(!rsp.total_hari){rsp.total_hari=0;}
me.generate_total_hari=rsp.total_hari;Ext.getCmp('grid_closingPurchasingDetail').setTitle('Generate Process..');me.generateAction_closingPurchasing(selected_data);},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();Ext.getCmp('grid_closingPurchasingDetail').setTitle('Closing Purchasing Detail');}});},generateAction_closingPurchasing:function(selected_data){var me=this;var theApp=me.app;if(!selected_data.allTanggal){ExtApp.Msg.info("Date undefined!");return;}
if(me.generate_total_hari==0){ExtApp.Msg.info("Total Day is 0, Please Re-Select Date and Generate!");return;}
if(me.generate_current_total==0){me.generate_current_total=1;}
var phpJs=theApp.getHelper('phpJs');var myMask=new Ext.LoadMask(Ext.getCmp('grid_closingPurchasing'),{msg:"Generate Closing Purchasing..."});myMask.show();Ext.Ajax.request({waitMsg:'Generating ...',url:appUrl+'audit_closing/closingPurchasing/generate',method:'POST',params:{is_check:0,total_hari:me.generate_total_hari,current_total:me.generate_current_total,closing_date:Ext.JSON.encode(selected_data.allTanggal)},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);myMask.hide();return false;}else{Ext.getCmp('grid_closingPurchasingDetail').setTitle(rsp.info);myMask.hide();}
me.generate_current_total+=1;if(me.generate_total_hari<me.generate_current_total){me.generate_current_total=0;me.generate_total_hari=0;Ext.getCmp('grid_closingPurchasing').store.load();}else{me.generateAction_closingPurchasing(selected_data);}},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);}});},closingConfirm_closingPurchasing:function(){var me=this;if(me.closing_data.tanggal){var getSelection=Ext.getCmp('grid_closingPurchasing').getSelectionModel().selected;var selected_data={allTanggal:[],allName:''};for(x in getSelection.items){if(getSelection.items[x].data.generate_status==1){selected_data.allTanggal.push(getSelection.items[x].data.tanggal);if(selected_data.allName==''){selected_data.allName=getSelection.items[x].data.tanggal;}else{selected_data.allName+=', '+getSelection.items[x].data.tanggal;}}else{ExtApp.Msg.info("Date: "+getSelection.items[x].data.tanggal+" Not Yet Generated!");return false;}}
ExtApp.Msg.confirm('Closing Selected Date <br/><br/><i>'+'<b>Anda yakin ?</b></i>',false,function(btn){if(btn=='yes'){me.closingAction_closingPurchasing(selected_data);}else{return false;}});}else{ExtApp.Msg.info("Please choose date!");}},closingAction_closingPurchasing:function(selected_data){var me=this;var theApp=me.app;if(!selected_data.allTanggal){ExtApp.Msg.info("Date undefined!");return;}
var phpJs=theApp.getHelper('phpJs');var myMask=new Ext.LoadMask(Ext.getCmp('grid_closingPurchasing'),{msg:"Closing Date Purchasing..."});myMask.show();Ext.Ajax.request({waitMsg:'Closing Date ...',url:appUrl+'audit_closing/closingPurchasing/closingDate',method:'POST',params:{closing_date:Ext.JSON.encode(selected_data.allTanggal)},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{ExtApp.Msg.info(rsp.info);}
Ext.getCmp('grid_closingPurchasing').store.load();myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);}});},openConfirm_closingPurchasing:function(){var me=this;if(me.closing_data.tanggal){var getSelection=Ext.getCmp('grid_closingPurchasing').getSelectionModel().selected;var selected_data={allTanggal:[],allName:''};for(x in getSelection.items){if(getSelection.items[x].data.closing_status==1){selected_data.allTanggal.push(getSelection.items[x].data.tanggal);if(selected_data.allName==''){selected_data.allName=getSelection.items[x].data.tanggal;}else{selected_data.allName+=', '+getSelection.items[x].data.tanggal;}}else{ExtApp.Msg.info("Date: "+getSelection.items[x].data.tanggal+" Not Yet Closed!");return false;}}
ExtApp.Msg.confirm('Closing Selected Date <br/><br/><i>'+'<b>Anda yakin ?</b></i>',false,function(btn){if(btn=='yes'){me.openAction_closingPurchasing(selected_data);}else{return false;}});}else{ExtApp.Msg.info("Please choose date!");}},openAction_closingPurchasing:function(selected_data){var me=this;var theApp=me.app;if(!selected_data.allTanggal){ExtApp.Msg.info("Date undefined!");return;}
var phpJs=theApp.getHelper('phpJs');var myMask=new Ext.LoadMask(Ext.getCmp('grid_closingPurchasing'),{msg:"Open Date Purchasing..."});myMask.show();Ext.Ajax.request({waitMsg:'Open Date ...',url:appUrl+'audit_closing/closingPurchasing/openDate',method:'POST',params:{closing_date:Ext.JSON.encode(selected_data.allTanggal)},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{ExtApp.Msg.info(rsp.info);}
Ext.getCmp('grid_closingPurchasing').store.load();myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);}});},reset_closingPurchasingDetail:function(){var me=this;var theApp=me.app;var phpJs=theApp.getHelper('phpJs');Ext.getCmp('dateFrom_closingPurchasing').setValue(phpJs.date('01-m-Y'));Ext.getCmp('dateTill_closingPurchasing').setValue(phpJs.date('t-m-Y'));me.search_closingPurchasing();},search_closingPurchasing:function(){var store_closingPurchasing=Ext.getCmp('grid_closingPurchasing').store;var store_closingPurchasingDetail=Ext.getCmp('grid_closingPurchasingDetail').store;store_closingPurchasing.proxy.extraParams.date_from=Ext.Date.format(Ext.getCmp('dateFrom_closingPurchasing').getValue(),'Y-m-d');store_closingPurchasing.proxy.extraParams.date_till=Ext.Date.format(Ext.getCmp('dateTill_closingPurchasing').getValue(),'Y-m-d');store_closingPurchasing.load();store_closingPurchasingDetail.loadData([]);}});