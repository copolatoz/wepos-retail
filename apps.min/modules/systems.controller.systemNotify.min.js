/**
 * Filename: systems.controller.systemNotify.js
 * Generated 2019-04-16 at 07:10:07 AM
 */
Ext.define('ExtApp.modules.systems.controller.systemNotify',{extend:'ExtApp.core.Module',id:'modules.systems.systemNotify',isloadModuleStore:false,suspendIfLoadStore:true,all_notif_feature:[],running_notif:0,running_wait_notif:0,running_next_notif:0,stop_notif:0,running_total_notif:0,generate_total_hari:0,generate_total_storehouse:0,generate_current_total:0,generate_current_total_storehouse:0,generate_data_storehouse:0,init:function(){this.launcher={text:'Notifikasi Sistem',iconCls:'icon-logout'};},useHelper:[],ModuleStore:{},ModuleModel:{},createWindow:function(me,winID,winFunc){var me=this;var win_func='openWindow';if(winFunc){win_func=winFunc;}
var win_id=me.id;if(winID){win_id=me.id+'_'+winID;if(!winFunc){win_func=winID;}}
var desktop=me.app.getDesktop();var win=me.app.getDesktop().getWindow(win_id);var systemNotifyW=new Ext.panel.Panel({id:me.id,border:true,shadow:false,width:300,floating:true,padding:15,renderTo:Ext.getBody(),items:[{xtype:'form',id:'form_systemNotify',width:300,border:false,bodyBorder:false,}],buttons:[{xtype:'displayfield',id:'systemNotify_display_info_footer',value:'Harap Menunggu Proses s/d Selesai..',fieldStyle:'font-weight:bold; color:blue;'},'->'],listeners:{boxready:function(){me.cekAplikasi();}}});systemNotifyW.alignTo(Ext.getBody(),"br",[-300,-100]);},doClose:function(winVar){var me=this;Ext.getCmp(me.id).hide();},cekAplikasi:function(){var me=this;var theApp=me.app;me.all_notif_feature=['loading','Cek Data Master','Cek Inventory','Cek Stok','Cek Finance','Bersihkan Data','Cek Closing'];me.all_notif_count=[0,0,0,0,0,0,0];me.running_notif=0;me.running_wait_notif=0;me.running_next_notif=0;me.stop_notif=0;me.running_total_notif=me.all_notif_feature.length;if(me.all_notif_feature.length==0){me.doClose(me.id);return false;}
me.runningNotify();},runningNotify:function(){var me=this;var theApp=me.app;if(me.running_notif>0&&me.running_wait_notif==1){var getValue=Ext.getCmp('systemNotify_display_info_footer').getValue();if(getValue=='&mdash; Loading...'){getValue='&mdash; Proses: '+me.all_notif_feature[me.running_notif]+'.';me.all_notif_count[me.running_notif]=0;}else{getValue+=' .';me.all_notif_count[me.running_notif]++;}
if(me.all_notif_count[me.running_notif]>=12){me.running_wait_notif=0;}
Ext.getCmp('systemNotify_display_info_footer').setValue(getValue);}
if(me.running_wait_notif==1&&me.stop_notif==1){var getValue='&mdash; Semua Proses Selesai..';Ext.getCmp('systemNotify_display_info_footer').setValue(getValue);}
if(me.running_wait_notif==0&&me.stop_notif==0){me.running_notif+=1
me.running_wait_notif=1;me.running_next_notif=me.running_notif+1;if(me.running_total_notif<=me.running_notif){me.running_next_notif=me.running_notif;me.stop_notif=1;}else{var getValue='&mdash; Proses: '+me.all_notif_feature[me.running_notif]+'.';Ext.getCmp('systemNotify_display_info_footer').setValue(getValue);}
if(me.all_notif_feature[me.running_notif]=='Cek Data Master'){me.cekDataMaster();}else
if(me.all_notif_feature[me.running_notif]=='Cek Inventory'){me.cekInventory();}else
if(me.all_notif_feature[me.running_notif]=='Cek Finance'){me.cekFinance();}else
if(me.all_notif_feature[me.running_notif]=='Bersihkan Data'){me.bersihkanData();}else
if(me.all_notif_feature[me.running_notif]=='Bersihkan Data'){me.cekClosing();}else
if(me.all_notif_feature[me.running_notif]=='Cek Stok'){me.generateStok();}else{setTimeout(function(){me.running_wait_notif=0;if(me.stop_notif==1){Ext.getCmp('systemNotify_display_info_footer').setValue('Aplikasi sudah siap digunakan...');me.doClose(me.id);}else{Ext.getCmp('systemNotify_display_info_footer').setValue('Proses: '+me.all_notif_feature[me.running_notif]+' Selesai...');}},5000);}}
if(me.stop_notif==0){setTimeout(function(){me.runningNotify();},1000);}},cekDataMaster:function(){var me=this;var theApp=me.app;var msg_info='&mdash; Proses Cek Data Master...';Ext.getCmp('systemNotify_display_info_footer').setValue(msg_info);var d=new Date();Ext.Ajax.request({waitMsg:'&mdash; Cek Data Master...',url:appUrl+'systems/WeposNotify/DataMaster?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);me.running_wait_notif=0;Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; '+rsp.info);},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Cek Data Master... Gagal!<br/>'+rsp.info);me.running_wait_notif=0;}});},cekInventory:function(){var me=this;var theApp=me.app;var msg_info='&mdash; Proses Cek Inventory...';Ext.getCmp('systemNotify_display_info_footer').setValue(msg_info);var d=new Date();Ext.Ajax.request({waitMsg:'&mdash; Cek Inventory...',url:appUrl+'systems/WeposNotify/Inventory?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);me.running_wait_notif=0;Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; '+rsp.info);},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Cek Inventory... Gagal!<br/>'+rsp.info);me.running_wait_notif=0;}});},cekFinance:function(){var me=this;var theApp=me.app;var msg_info='&mdash; Proses Cek Finance...';Ext.getCmp('systemNotify_display_info_footer').setValue(msg_info);var d=new Date();Ext.Ajax.request({waitMsg:'&mdash; Cek Finance...',url:appUrl+'systems/WeposNotify/Finance?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);me.running_wait_notif=0;Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; '+rsp.info);},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Cek Finance... Gagal!<br/>'+rsp.info);me.running_wait_notif=0;}});},bersihkanData:function(){var me=this;var theApp=me.app;var msg_info='&mdash; Proses Bersihkan Data...';Ext.getCmp('systemNotify_display_info_footer').setValue(msg_info);var d=new Date();Ext.Ajax.request({waitMsg:'&mdash; Bersihkan Data...',url:appUrl+'systems/WeposNotify/Bersihkan_data?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);me.running_wait_notif=0;Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; '+rsp.info);},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Bersihkan Data... Gagal!<br/>'+rsp.info);me.running_wait_notif=0;}});},cekClosing:function(){var me=this;var theApp=me.app;var msg_info='&mdash; Proses Cek Closing...';Ext.getCmp('systemNotify_display_info_footer').setValue(msg_info);var d=new Date();Ext.Ajax.request({waitMsg:'&mdash; Cek Closing...',url:appUrl+'systems/WeposNotify/Closing?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);me.running_wait_notif=0;Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; '+rsp.info);},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Cek Closing... Gagal!<br/>'+rsp.info);me.running_wait_notif=0;}});},generateStok:function(){var me=this;var theApp=me.app;var msg_info='&mdash; Cek & Generate Stok...';Ext.getCmp('systemNotify_display_info_footer').setValue(msg_info);var d=new Date();Ext.Ajax.request({waitMsg:'&mdash; Cek & Generate Stok...',url:appUrl+'inventory/listStock/lastgenerate?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; '+rsp.info);var selected_data={allTanggal:[]};if(rsp.success){if(rsp.generated==1){var selected_data={allTanggal:[rsp.last]};}}
for(x in rsp.na_tanggal){selected_data.allTanggal.push(rsp.na_tanggal[x]);}
me.generateCheck_listStock(selected_data);},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Cek & Generate Stok... Gagal!<br/>'+rsp.info);me.running_wait_notif=0;}});},generateCheck_listStock:function(selected_data){var me=this;var theApp=me.app;if(!selected_data.allTanggal){Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Data tidak dikenali!');return;}
me.generate_total_hari=0;me.generate_total_storehouse=0;me.generate_data_storehouse=[];Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Persiapan Generate Stok...');var phpJs=theApp.getHelper('phpJs');Ext.Ajax.request({waitMsg:'Checking ...',url:appUrl+'inventory/listStock/generate',method:'POST',params:{nofity:1,is_check:1,closing_date:Ext.JSON.encode(selected_data.allTanggal)},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){me.running_wait_notif=0;return;}else{}
if(!rsp.total_hari){rsp.total_hari=0;}
me.generate_total_hari=rsp.total_hari;me.generate_total_storehouse=rsp.total_storehouse;me.generate_data_storehouse=rsp.storehouse;Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Proses Persiapan Generate Stok...');me.generateAction_listStock(selected_data);},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Persiapan Generate Stok... Gagal!');me.running_wait_notif=0;}});},generateAction_listStock:function(selected_data){var me=this;var theApp=me.app;if(!selected_data.allTanggal){Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Data tidak dikenali!');return;}
if(me.generate_total_hari==0){Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Generate Stok Gagal, Re-Generate via Daftar Stok!');return;}
if(me.generate_total_storehouse==0){Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Gudang tidak dikenali, Re-Generate via Daftar Stok!');return;}
if(me.generate_current_total==0){me.generate_current_total=1;}
if(me.generate_current_total_storehouse==0){me.generate_current_total_storehouse=1;}
Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Proses Generate Stok...');var phpJs=theApp.getHelper('phpJs');Ext.Ajax.request({waitMsg:'Generating ...',url:appUrl+'inventory/listStock/generate',method:'POST',params:{nofity:1,is_check:0,total_hari:me.generate_total_hari,total_storehouse:me.generate_total_storehouse,current_total:me.generate_current_total,current_total_storehouse:me.generate_current_total_storehouse,data_storehouse:Ext.JSON.encode(me.generate_data_storehouse),closing_date:Ext.JSON.encode(selected_data.allTanggal)},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){Ext.getCmp('systemNotify_display_info_footer').setValue(rsp.info);return false;}else{Ext.getCmp('systemNotify_display_info_footer').setValue(rsp.info);}
me.generate_current_total_storehouse+=1;if(me.generate_total_storehouse<me.generate_current_total_storehouse){me.generate_current_total+=1;me.generate_current_total_storehouse=0;}
if(me.generate_total_hari<me.generate_current_total){me.generate_current_total=0;me.generate_total_hari=0;me.generate_total_storehouse=0;me.generate_current_total_storehouse=0;me.generate_data_storehouse=[];Ext.getCmp('systemNotify_display_info_footer').setValue('&mdash; Cek & Generate Stok Selesai..');me.running_wait_notif=0;}else{me.generateAction_listStock(selected_data);}},failure:function(response,options){var rsp=Ext.decode(response.responseText);Ext.getCmp('systemNotify_display_info_footer').setValue(rsp.info);me.running_wait_notif=0;}});}});setTimeout(function(){Ext.getCmp('ExtApp.modules.systems.controller.systemNotify').fireEvent('click');},1000);