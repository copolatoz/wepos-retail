/**
 * Filename: monitoring.controller.generateAutoClosing.js
 * Generated 2018-09-04 at 08:57:45 PM
 */
var generateAutoClosing_timeout;Ext.define('ExtApp.modules.monitoring.controller.generateAutoClosing',{extend:'ExtApp.core.Module',id:'modules.monitoring.generateAutoClosing',isloadModuleStore:true,suspendIfLoadStore:true,loop_timer:0,closing_time:0,generate_current_task:0,task_total:0,task_data:[],init:function(){this.launcher={text:'Generate Auto Closing',iconCls:'icon-grid'};},useHelper:[],ModuleStore:{'monitoring':[{store_name:'store_generateAutoClosing',autoload:false},{store_name:'store_generateAutoClosingDetail',autoload:false}]},ModuleModel:{'monitoring':[{model_name:'model_generateAutoClosing'},{model_name:'model_generateAutoClosingDetail'}]},createWindow:function(me,winID,winFunc){var me=this;var win_func='openWindow';if(winFunc){win_func=winFunc;}
var win_id=me.id;if(winID){win_id=me.id+'_'+winID;if(!winFunc){win_func=winID;}}
var desktop=me.app.getDesktop();var win=me.app.getDesktop().getWindow(win_id);if(!win){me.app.createView('ExtApp.modules.monitoring.view.generateAutoClosing',me,win_func);}else{me.app.desktop.restoreWindow(win);}},doClose:function(winVar){var me=this;var win=me.app.getDesktop().getWindow(winVar);if(win){win.doClose();}},generateConfirm_generateAutoClosing:function(){var me=this;var theApp=me.app;Ext.getCmp('grid_generateAutoClosingDetail').setTitle('Checking Options..');var phpJs=theApp.getHelper('phpJs');var myMask=new Ext.LoadMask(Ext.getCmp('grid_generateAutoClosingDetail'),{msg:"Generate Check Options..."});myMask.show();Ext.Ajax.request({waitMsg:'Checking ...',url:appUrl+'monitoring/generateAutoClosing/generate',method:'POST',params:{is_check:1},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);myMask.hide();return;}else{myMask.hide();}
if(rsp.loop_timer==0||rsp.closing_time==0){ExtApp.Msg.warning("Option: Loop Timer and Closing Time not available!");return false;}
me.loop_timer=rsp.loop_timer;me.closing_time=rsp.closing_time;me.task_total=rsp.task_total;me.task_data=rsp.task_data;Ext.getCmp('grid_generateAutoClosingDetail').setTitle('Preparing Generate..');me.generateAction_generateAutoClosing();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();Ext.getCmp('grid_generateAutoClosingDetail').setTitle('Service Log');Ext.getCmp('infoGenerate_generateAutoClosing').setValue('');}});},generateAction_generateAutoClosing:function(){var me=this;var theApp=me.app;var generate_current_task_text='';if(me.generate_current_task==0){me.generate_current_task=1;}
if(me.task_data[me.generate_current_task]!=''){generate_current_task_text=me.task_data[me.generate_current_task];}
var phpJs=theApp.getHelper('phpJs');Ext.Ajax.request({waitMsg:'Generating ...',url:appUrl+'monitoring/generateAutoClosing/generate',method:'POST',params:{is_check:0,generate_current_task:me.generate_current_task},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);return false;}else{Ext.getCmp('grid_generateAutoClosingDetail').setTitle(rsp.info);}
me.generate_current_task+=1;if(me.task_total<me.generate_current_task){me.generate_current_task=0;me.task_total=0;generateAutoClosing_timeout=setTimeout(function(){me.generateConfirm_generateAutoClosing();},me.loop_timer);Ext.getCmp('infoGenerate_generateAutoClosing').setValue('Idle Time For 1 Hour..');}else{if(rsp.status=='on Progress'){Ext.Ajax.request({waitMsg:'Checking ...',url:appUrl+rsp.dt_return.module+'/'+rsp.dt_return.file+'/'+rsp.dt_return.action,method:'POST',params:{is_check:rsp.dt_return.is_check,current_total:rsp.dt_return.current_total,closing_date:Ext.JSON.encode(rsp.dt_return.closing_date),auto_cancel:rsp.dt_return.auto_cancel,from_autoclosing:1},success:function(response,options){var rsp_task=Ext.decode(response.responseText);if(rsp_task.success==false){me.saveLog_generateAutoClosing(false,rsp.dt_return,rsp_task.info);}else{me.saveLog_generateAutoClosing(true,rsp.dt_return,rsp_task.info);}},failure:function(response,options){var rsp_task=Ext.decode(response.responseText);me.saveLog_generateAutoClosing(false,rsp.dt_return,rsp_task.info);}});}
generateAutoClosing_timeout=setTimeout(function(){me.generateAction_generateAutoClosing();},600000);Ext.getCmp('infoGenerate_generateAutoClosing').setValue('Auto Process Every 10 Minutes..');}},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);}});},saveLog_generateAutoClosing:function(statusTask,dt_return,info){var me=this;var theApp=me.app;Ext.Ajax.request({waitMsg:'Save Log ...',url:appUrl+'monitoring/generateAutoClosing/saveLog',method:'POST',params:{task_status:statusTask,notes:info,task_data:Ext.JSON.encode(dt_return)},success:function(response,options){Ext.getCmp('grid_generateAutoClosingDetail').store.load();},failure:function(response,options){}});},stop_generateAutoClosing:function(){var me=this;var theApp=me.app;Ext.getCmp('grid_generateAutoClosingDetail').setTitle('Service Log');Ext.getCmp('infoGenerate_generateAutoClosing').setValue('');me.generate_current_task=0;me.task_total=0;clearTimeout(generateAutoClosing_timeout);},setup_generateAutoClosing:function(){var store_generateAutoClosing=Ext.getCmp('grid_generateAutoClosing').store;var store_generateAutoClosingDetail=Ext.getCmp('grid_generateAutoClosingDetail').store;store_generateAutoClosing.load();store_generateAutoClosingDetail.load();}});