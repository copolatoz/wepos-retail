/**
 * Filename: purchase.purchaseOrder.js
 * Generated 2019-04-23 at 03:33:24 AM
 */
Ext.define('ExtApp.modules.master_pos.model.model_masterItem',{extend:'Ext.data.Model',alias:'model_masterItem',fields:[{name:'id',type:'int'},{name:'item_code',type:'string'},{name:'item_sku',type:'string'},{name:'item_name',type:'string'},{name:'item_code_name',type:'string'},{name:'item_name_code',type:'string'},{name:'item_desc',type:'string'},{name:'item_manufacturer',type:'string'},{name:'sales_price',type:'string'},{name:'sales_price_show',type:'string'},{name:'item_price',type:'string'},{name:'item_price_show',type:'string'},{name:'item_hpp',type:'string'},{name:'item_hpp_show',type:'string'},{name:'last_in',type:'string'},{name:'last_in_show',type:'string'},{name:'total_qty_stok',type:'string'},{name:'item_type',type:'string'},{name:'item_type_name',type:'string'},{name:'item_image',type:'string'},{name:'item_image_show',type:'string'},{name:'item_image_src',type:'string'},{name:'category_id',type:'int'},{name:'item_category_name',type:'string'},{name:'item_category_code',type:'string'},{name:'subcategory_id',type:'int'},{name:'item_subcategory_name',type:'string'},{name:'item_subcategory_code',type:'string'},{name:'unit_id',type:'int'},{name:'unit_name',type:'string'},{name:'unit_code',type:'string'},{name:'supplier_id',type:'int'},{name:'supplier_name',type:'string'},{name:'is_active',type:'int'},{name:'is_active_text',type:'string'},{name:'use_for_sales',type:'int'},{name:'use_for_sales_text',type:'string'},{name:'id_ref_menu',type:'int'},{name:'sales_use_tax',type:'int'},{name:'sales_use_tax_text',type:'string'},{name:'sales_use_service',type:'int'},{name:'sales_use_service_text',type:'string'},{name:'is_kerjasama',type:'int'},{name:'is_kerjasama_text',type:'string'},{name:'persentase_bagi_hasil',type:'string'},{name:'total_bagi_hasil',type:'string'},{name:'total_bagi_hasil',type:'string'},{name:'total_bagi_hasil_show',type:'string'},{name:'use_stok_kode_unik',type:'int'},{name:'use_stok_kode_unik_text',type:'string'},{name:'min_stock',type:'string'}],proxy:{type:'ajax',url:appUrl+'master_pos/masterItem/gridData',extraParams:{},actionMethods:{read:'POST'},reader:{type:'json',root:'data',idProperty:'id',totalProperty:'totalCount'}}});Ext.define('ExtApp.modules.master_pos.model.model_masterSupplierItem',{extend:'Ext.data.Model',alias:'model_masterSupplierItem',fields:[{name:'id',type:'int'},{name:'supplier_id',type:'string'},{name:'supplier_name',type:'string'},{name:'supplier_address',type:'string'},{name:'unit_id',type:'string'},{name:'unit_name',type:'string'},{name:'supplier_item_id',type:'string'},{name:'item_id',type:'string'},{name:'item_code',type:'string'},{name:'item_code_name',type:'string'},{name:'item_name',type:'string'},{name:'item_price',type:'string'},{name:'item_price_show',type:'string'},{name:'item_hpp',type:'string'},{name:'item_hpp_show',type:'string'},{name:'is_active',type:'int'},{name:'is_active_text',type:'string'},{name:'from_supplier_item',type:'string'},{name:'last_in',type:'string'},{name:'last_in_show',type:'string'}],proxy:{type:'ajax',url:appUrl+'master_pos/masterSupplierItem/gridData',extraParams:{},actionMethods:{read:'POST'},reader:{type:'json',root:'data',idProperty:'id',totalProperty:'totalCount'}}});Ext.define('ExtApp.modules.master_pos.model.model_masterSupplier',{extend:'Ext.data.Model',alias:'model_masterSupplier',fields:[{name:'id',type:'int'},{name:'supplier_code',type:'string'},{name:'supplier_name',type:'string'},{name:'supplier_contact_person',type:'string'},{name:'supplier_address',type:'string'},{name:'supplier_phone',type:'string'},{name:'supplier_fax',type:'string'},{name:'supplier_email',type:'string'},{name:'supplier_status',type:'string'},{name:'supplier_status_text',type:'string'},{name:'keterangan_blacklist',type:'string'},{name:'source_from',type:'string'},{name:'is_active',type:'int'},{name:'is_active_text',type:'string'}],proxy:{type:'ajax',url:appUrl+'master_pos/masterSupplier/gridData',extraParams:{},actionMethods:{read:'POST'},reader:{type:'json',root:'data',idProperty:'id',totalProperty:'totalCount'}}});Ext.define('ExtApp.modules.master_pos.model.model_masterUnit',{extend:'Ext.data.Model',alias:'model_masterUnit',fields:[{name:'id',type:'int'},{name:'unit_name',type:'string'},{name:'unit_code',type:'string'},{name:'is_active',type:'int'},{name:'is_active_text',type:'string'}],proxy:{type:'ajax',url:appUrl+'master_pos/masterUnit/gridData',extraParams:{},actionMethods:{read:'POST'},reader:{type:'json',root:'data',idProperty:'id',totalProperty:'totalCount'}}});Ext.define('ExtApp.modules.purchase.model.model_purchaseOrder',{extend:'Ext.data.Model',alias:'model_purchaseOrder',fields:[{name:'id',type:'int'},{name:'po_number',type:'string'},{name:'supplier_id',type:'string'},{name:'supplier_name',type:'string'},{name:'supplier_invoice',type:'string'},{name:'po_date',type:'string'},{name:'po_date_txt',type:'string'},{name:'po_memo',type:'string'},{name:'po_total_qty',type:'string'},{name:'po_sub_total',type:'string'},{name:'po_sub_total_text',type:'string'},{name:'po_discount',type:'string'},{name:'po_discount_text',type:'string'},{name:'po_tax',type:'string'},{name:'po_tax_text',type:'string'},{name:'po_shipping',type:'string'},{name:'po_total_price',type:'string'},{name:'po_total_price_text',type:'string'},{name:'po_payment',type:'string'},{name:'payment_note',type:'string'},{name:'po_status',type:'string'},{name:'po_status_text',type:'string'},{name:'po_project',type:'string'},{name:'po_ship_to',type:'string'},{name:'createdby',type:'string'},{name:'is_active',type:'string'},{name:'is_active_text',type:'string'},{name:'used_on_receiving',type:'int'},{name:'po_number_rl_status',type:'string'},{name:'supplier_from_ro',type:'int'},{name:'use_approval',type:'int'},{name:'approval_status',type:'string'},{name:'approval_status_text',type:'string'}],proxy:{type:'ajax',url:appUrl+'purchase/purchaseOrder/gridData',extraParams:{},actionMethods:{read:'POST'},reader:{type:'json',root:'data',idProperty:'id',totalProperty:'totalCount'}}});Ext.define('ExtApp.modules.purchase.model.model_purchaseOrderDetail',{extend:'Ext.data.Model',alias:'model_purchaseOrderDetail',fields:[{name:'id',type:'string'},{name:'po_id',type:'string'},{name:'supplier_item_id',type:'string'},{name:'item_id',type:'string'},{name:'item_code',type:'string'},{name:'item_code_name',type:'string'},{name:'item_name',type:'string'},{name:'item_price',type:'string'},{name:'item_hpp',type:'string'},{name:'item_image',type:'string'},{name:'unit_id',type:'string'},{name:'unit_name',type:'string'},{name:'po_detail_qty',type:'string'},{name:'po_receive_qty',type:'string'},{name:'po_detail_status',type:'string'},{name:'po_detail_purchase',type:'string'},{name:'po_detail_purchase_show',type:'string'},{name:'po_detail_potongan',type:'string'},{name:'po_detail_potongan_show',type:'string'},{name:'po_detail_total',type:'string'},{name:'po_detail_total_show',type:'string'},{name:'po_receive_total',type:'string'},{name:'po_receive_total_show',type:'string'},{name:'ro_detail_id',type:'string'},{name:'ro_number',type:'string'},{name:'nomor',type:'int'}],proxy:{type:'ajax',url:appUrl+'purchase/purchaseOrder/gridDataDetail',extraParams:{},actionMethods:{read:'POST'},reader:{type:'json',root:'data',idProperty:'id',totalProperty:'totalCount'}}});Ext.define('ExtApp.modules.purchase.model.model_purchaseOrderDetail_RO',{extend:'Ext.data.Model',alias:'model_purchaseOrderDetail_RO',fields:[{name:'id',type:'string'},{name:'po_id',type:'string'},{name:'supplier_item_id',type:'string'},{name:'item_id',type:'string'},{name:'item_code',type:'string'},{name:'item_code_name',type:'string'},{name:'item_name',type:'string'},{name:'item_price',type:'string'},{name:'item_image',type:'string'},{name:'unit_id',type:'string'},{name:'unit_name',type:'string'},{name:'po_detail_qty',type:'string'},{name:'po_detail_status',type:'string'},{name:'po_detail_purchase',type:'string'},{name:'po_detail_purchase_show',type:'string'},{name:'po_detail_potongan',type:'string'},{name:'po_detail_potongan_show',type:'string'},{name:'po_detail_total',type:'string'},{name:'po_detail_total_show',type:'string'},{name:'ro_id',type:'string'},{name:'ro_number',type:'string'},{name:'ro_detail_id',type:'string'}],proxy:{type:'ajax',url:appUrl+'purchase/purchaseOrder/gridDataDetailRO',extraParams:{},actionMethods:{read:'POST'},reader:{type:'json',root:'data',idProperty:'id',totalProperty:'totalCount'}}});Ext.define('ExtApp.modules.master_pos.store.store_masterItem',{extend:'Ext.data.Store',model:'ExtApp.modules.master_pos.model.model_masterItem',autoLoad:false,remoteSort:true});Ext.define('ExtApp.modules.master_pos.store.store_masterSupplierItem',{extend:'Ext.data.Store',model:'ExtApp.modules.master_pos.model.model_masterSupplierItem',autoLoad:false,remoteSort:true});Ext.define('ExtApp.modules.master_pos.store.store_masterSupplier',{extend:'Ext.data.Store',model:'ExtApp.modules.master_pos.model.model_masterSupplier',autoLoad:false,remoteSort:true});Ext.define('ExtApp.modules.master_pos.store.store_masterUnit',{extend:'Ext.data.Store',model:'ExtApp.modules.master_pos.model.model_masterUnit',autoLoad:false,remoteSort:true});Ext.define('ExtApp.modules.purchase.store.store_purchaseOrder',{extend:'Ext.data.Store',model:'ExtApp.modules.purchase.model.model_purchaseOrder',autoLoad:false,remoteSort:true});Ext.define('ExtApp.modules.purchase.store.store_purchaseOrderDetail',{extend:'Ext.data.Store',model:'ExtApp.modules.purchase.model.model_purchaseOrderDetail',autoLoad:false,remoteSort:true});Ext.define('ExtApp.modules.purchase.store.store_purchaseOrderDetail_RO',{extend:'Ext.data.Store',model:'ExtApp.modules.purchase.model.model_purchaseOrderDetail_RO',autoLoad:false,remoteSort:true});Ext.define("ExtApp.modules.purchase.view.purchaseOrder",{openWindow:function(me){var theApp=me.app;var desktop=theApp.getDesktop();var store_purchaseOrder_grid=theApp.getStore('store_purchaseOrder_grid',false);if(store_purchaseOrder_grid==false){store_purchaseOrder_grid=theApp.copyStore('purchase','store_purchaseOrder','store_purchaseOrder_grid');}
store_purchaseOrder_grid.proxy.extraParams.po_status='';store_purchaseOrder_grid.proxy.extraParams.skip_date=0;store_purchaseOrder_grid.proxy.extraParams.is_dropdown=0;store_purchaseOrder_grid.proxy.extraParams.is_rl=0;var helperGrid=theApp.getHelper('Grid');var phpJs=theApp.getHelper('phpJs');var selModel_purchaseOrder=Ext.create('Ext.selection.CheckboxModel',{listeners:{selectionchange:function(sm,selections){Ext.getCmp('grid_purchaseOrder').down('#deleteButton_purchaseOrder').setDisabled(selections.length==0);}}});me.use_approval_po=0;me.approval_change_payment_po_done=0;me.pagingtb_purchaseOrder=helperGrid.paging({ds:store_purchaseOrder_grid,title:'Purchase Order'});return desktop.createWindow({id:me.id,title:'Purchase Order',width:850,height:500,iconCls:'icon-grid',animCollapse:false,constrainHeader:true,resizable:true,maximized:false,border:false,border:0,layout:{type:'border'},items:[{xtype:'form',title:'Filter',width:330,region:'west',id:'form_filter_purchaseOrder',split:true,collapsible:true,splitterResize:false,collapseMode:'mini',animCollapse:true,scroll:false,bodyPadding:10,margin:'0 0 0 0',items:[{xtype:'textfield',name:'keywords',labelWidth:60,labelSeparator:'',emptyText:'Keywords: PO.NO / Supplier Name / Invoice',anchor:'100%',margin:'0 0 15 0',listeners:{specialkey:function(field,e){if(e.getKey()==e.ENTER){me.search_purchaseOrder();}}}},{xtype:'panel',border:0,layout:{type:'column'},margin:'0 0 15 0',items:[{xtype:'datefield',fieldLabel:'Date From',name:'date_from',labelSeparator:'',format:'d-m-Y',altFormats:'Y-m-d|d-m-Y|dmY|Ymd',margin:'5 0 0 0',labelWidth:65,width:170,value:phpJs.date('d-m-Y'),allowBlank:false},{xtype:'datefield',fieldLabel:' To ',name:'date_till',labelSeparator:'',format:'d-m-Y',altFormats:'Y-m-d|d-m-Y|dmY|Ymd',margin:'5 0 0 10',labelWidth:20,width:125,value:phpJs.date('d-m-Y'),allowBlank:false}]},{xtype:'container',style:'text-align:right',border:0,items:[{xtype:'button',text:'Search',scale:'medium',margin:'15 0 0 0',itemId:'btnFilterSearch_purchaseOrder',tooltip:'Search',iconCls:'btn-search',handler:function(){me.search_purchaseOrder();}},{xtype:'button',text:'Reset',scale:'medium',margin:'15 60 0 10',itemId:'btnFilterReset_purchaseOrder',tooltip:'Reset',iconCls:'btn-reset',handler:function(){var form=Ext.getCmp('form_filter_purchaseOrder').getForm();form.reset();form.findField('keywords').setValue('');form.findField('date_from').setValue(phpJs.date('01-m-Y'));form.findField('date_till').setValue(phpJs.date('t-m-Y'));me.search_purchaseOrder();}}]}]},{xtype:'gridpanel',margins:'0 0 0 0',region:'center',store:store_purchaseOrder_grid,id:'grid_purchaseOrder',scroll:true,selModel:selModel_purchaseOrder,columns:[{xtype:'gridcolumn',dataIndex:'id',text:'ID',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'supplier_id',text:'Supplier ID',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'po_number',text:'PO.NO',width:90},{xtype:'datecolumn',dataIndex:'po_date',text:'Date',width:90,format:'d/m/Y'},{xtype:'gridcolumn',dataIndex:'supplier_invoice',text:'Ref.No',width:100},{xtype:'gridcolumn',dataIndex:'po_payment',text:'Payment',width:100},{xtype:'gridcolumn',dataIndex:'supplier_name',text:'Supplier',width:250},{xtype:'gridcolumn',dataIndex:'po_total_price_text',text:'Total Price',width:100},{xtype:'gridcolumn',dataIndex:'po_status_text',text:'Status',width:90},{xtype:'gridcolumn',dataIndex:'approval_status_text',text:'Approval',width:90},{xtype:'gridcolumn',dataIndex:'createdby',text:'User Input',width:120}],viewConfig:{stripeRows:true,forceFit:true},listeners:{itemdblclick:function(view,rec,item,index,eventObj){var getSelection=Ext.getCmp('grid_purchaseOrder').getSelectionModel().selected;if(getSelection.length>0){me.formType='edit';me.edit_data=rec.data;me.createWindow(me,'add_purchaseOrder');}}},bbar:me.pagingtb_purchaseOrder,dockedItems:[{xtype:'toolbar',dock:'top',items:[{text:'Filter',itemId:'filterButton_purchaseOrder',tooltip:'Filter Purchase Order',iconCls:'btn-search',listeners:{click:function(){Ext.getCmp('form_filter_purchaseOrder').toggleCollapse();}}},'->',{text:'Add',itemId:'addButton_purchaseOrder',tooltip:'Add Purchase Order',iconCls:'btn-add',handler:function(){me.formType='add';me.edit_data=[];me.createWindow(me,'add_purchaseOrder');}},'-',{text:'Delete',itemId:'deleteButton_purchaseOrder',tooltip:'Delete Purchase Order',iconCls:'btn-delete',disabled:true,handler:function(){var getSelection=Ext.getCmp('grid_purchaseOrder').getSelectionModel().selected;if(getSelection.length>0){me.delete_data=getSelection.items[0].data;if(me.delete_data.po_status=='done'){ExtApp.Msg.warning('Cannot Delete '+me.delete_data.po_number+'<br/>Purchase Order been taken / used');}else{me.deleteConfirm_purchaseOrder();}}else{ExtApp.Msg.info('Please Select Purchase Order!');}}},'-',{text:'Refresh',itemId:'refreshButton_purchaseOrder',tooltip:'Refresh Purchase Order',iconCls:'btn-refresh',handler:function(){Ext.getCmp('grid_purchaseOrder').store.load();}}]}]}],listeners:{boxready:function(){Ext.getCmp('form_filter_purchaseOrder').toggleCollapse();me.search_purchaseOrder();me.load_use_approval_po();},show:function(){}}});},add_purchaseOrder:function(me){var theApp=me.app;var desktop=theApp.getDesktop();var Titletext='Add New PO';if(me.formType=='edit'){Titletext='Update PO';me.store_purchaseOrderDetail=theApp.getStore('purchase.store_purchaseOrderDetail',false);me.store_purchaseOrderDetailTemp=theApp.copyStore('purchase','store_purchaseOrderDetail','store_purchaseOrderDetailTemp');}else{me.store_purchaseOrderDetail=theApp.getStore('purchase.store_purchaseOrderDetail_RO',false);me.store_purchaseOrderDetailTemp=theApp.copyStore('purchase','store_purchaseOrderDetail_RO','store_purchaseOrderDetailTemp');}
var store_ComboboxMasterSupplier_purchaseOrderDetail=theApp.getStore('store_ComboboxMasterSupplier_purchaseOrderDetail',false);if(store_ComboboxMasterSupplier_purchaseOrderDetail==false){store_ComboboxMasterSupplier_purchaseOrderDetail=theApp.copyStore('master_pos','store_masterSupplier','store_ComboboxMasterSupplier_purchaseOrderDetail');}
store_ComboboxMasterSupplier_purchaseOrderDetail.proxy.extraParams.limit=9999999;store_ComboboxMasterSupplier_purchaseOrderDetail.proxy.extraParams.show_choose_text=0;store_ComboboxMasterSupplier_purchaseOrderDetail.proxy.extraParams.show_all_text=0;store_ComboboxMasterSupplier_purchaseOrderDetail.proxy.extraParams.is_dropdown=1;store_ComboboxMasterSupplier_purchaseOrderDetail.proxy.extraParams.keywords='';store_ComboboxMasterSupplier_purchaseOrderDetail.proxy.extraParams.validated=1;var helperGridDetail=theApp.getHelper('Grid');var phpJs=theApp.getHelper('phpJs');var selModel_purchaseOrderDetail=Ext.create('Ext.selection.CheckboxModel',{listeners:{selectionchange:function(sm,selections){}}});var store_po_payment=new Ext.data.Store({fields:['val','name'],data:[{"val":"cash","name":"Cash"},{"val":"credit","name":"Credit"}],autoLoad:true});var add_parameter='_dc='+phpJs.mktime();add_parameter+='&po_id=';add_parameter+='&do=';var url_report=appUrl+'purchase/purchaseOrder/printPO?'+add_parameter;return desktop.createWindow({id:me.id+'_add_purchaseOrder',title:Titletext,width:800,height:550,iconCls:'btn-add',animCollapse:false,constrainHeader:true,resizable:true,minimizable:false,maximizable:false,modal:true,border:0,layout:{type:'fit'},items:[{xtype:'panel',height:545,title:'',bodyPadding:5,items:[{xtype:'panel',style:'padding-bottom: 5px;',id:'purchaseOrder_detailArea',title:'',border:1,items:[{xtype:'form',id:'form_purchaseOrder',height:215,title:'',border:0,dockedItems:[{xtype:'panel',bodyPadding:10,width:390,title:'',dock:'left',flex:1,border:false,items:[{xtype:'hidden',name:'form_type_purchaseOrder',value:me.formType},{xtype:'hidden',name:'id'},{xtype:'textfield',name:'po_number',fieldLabel:'PO Number',labelWidth:100,anchor:'60%',disabled:true,value:'auto',allowBlank:false},{xtype:'datefield',name:'po_date',fieldLabel:'Date',format:'d-m-Y',submitFormat:'Y-m-d',allowBlank:false},{xtype:'checkbox',name:'supplier_from_ro',fieldLabel:'From Request Order?',inputValue:'1',labelWidth:130,hidden:true,listeners:{change:function(combo,records,eOpts){var form=Ext.getCmp('form_purchaseOrder').getForm();var supplier_from_ro=form.findField('supplier_from_ro').getSubmitValue();if(supplier_from_ro==1){store_ComboboxMasterSupplier_purchaseOrderDetail.proxy.extraParams.validated=1;}else{store_ComboboxMasterSupplier_purchaseOrderDetail.proxy.extraParams.validated=0;}
store_ComboboxMasterSupplier_purchaseOrderDetail.load({callback:function(){if(me.formType=='add'){form.findField('supplier_id').setValue(0);form.findField('supplier_name').setValue('');}}});}}},{xtype:'hidden',name:'supplier_id'},{xtype:'combobox',name:'supplier_name',fieldLabel:'Supplier',emptyText:'(Auto Complete)',labelWidth:100,anchor:'100%',width:370,allowBlank:false,store:store_ComboboxMasterSupplier_purchaseOrderDetail,displayField:'supplier_name',valueField:'id',hideTrigger:true,queryMode:'local',anyMatch:true,listeners:{select:function(combo,records,eOpts){var form=Ext.getCmp('form_purchaseOrder').getForm();form.findField('supplier_id').setValue(records[0].data.id);form.findField('supplier_name').setValue(records[0].data.supplier_name);form.findField('po_memo').setValue(records[0].data.po_memo);var myMask=new Ext.LoadMask(Ext.getCmp('purchaseOrder_detailArea'),{msg:"Loading..."});myMask.show();var myMask2=new Ext.LoadMask(Ext.getCmp('grid_purchaseOrderDetail'),{msg:"Loading..."});myMask2.show();me.store_purchaseOrderDetailTemp.proxy.extraParams.supplier_id=records[0].data.id;me.store_purchaseOrderDetailTemp.proxy.extraParams.limit=9999;me.store_purchaseOrderDetailTemp.load({callback:function(){var d=me.store_purchaseOrderDetailTemp.getRange(0);var dataTemp=[];var no=1;var total_detail=0;for(var i=0;i<d.length;i++)
{var dtDetPO={po_id:d[i].data.po_id,ro_detail_id:d[i].data.ro_detail_id,supplier_item_id:d[i].data.supplier_item_id,item_id:d[i].data.item_id,item_code:d[i].data.item_code,item_code_name:d[i].data.item_code_name,item_name:d[i].data.item_name,unit_id:d[i].data.unit_id,unit_name:d[i].data.unit_name,po_detail_qty:d[i].data.po_detail_qty,po_detail_purchase:d[i].data.po_detail_purchase,po_detail_potongan:d[i].data.po_detail_potongan,po_detail_total:d[i].data.po_detail_total,po_detail_purchase_show:d[i].data.po_detail_purchase_show,po_detail_potongan_show:d[i].data.po_detail_potongan_show,po_detail_total_show:d[i].data.po_detail_total_show,po_detail_status:d[i].data.po_detail_status,ro_number:d[i].data.ro_number,id:'new_'+d[i].data.id}
total_detail+=parseFloat(d[i].data.po_detail_total);no++;dataTemp.push(dtDetPO);}
me.store_purchaseOrderDetailTemp.loadData(dataTemp);form.findField('po_sub_total').setValue(total_detail);form.findField('po_total_price').setValue(total_detail);form.findField('po_total_price_text').setValue('Rp '+phpJs.priceFormat(total_detail));form.findField('po_sub_total_text').setValue('Rp '+phpJs.priceFormat(total_detail));myMask.hide();myMask2.hide();}});},}},{xtype:'textfield',name:'supplier_invoice',fieldLabel:'Ref.No',labelWidth:100,width:370,anchor:'100%',},{xtype:'textfield',name:'po_memo',fieldLabel:'Memo',anchor:'100%',width:370,},{xtype:'displayfield',name:'po_status',fieldLabel:'Status',anchor:'100%',width:370,},{xtype:'hidden',name:'po_project'},{xtype:'hidden',name:'po_ship_to'},{xtype:'textfield',id:me.id+'_PurchaseOrder_spv',hidden:true,name:'spv_user',allowEmpty:false},]},{xtype:'panel',bodyPadding:10,width:390,title:'',dock:'left',flex:1,border:false,items:[{xtype:'combobox',name:'po_payment',fieldLabel:'Payment',anchor:'100%',store:store_po_payment,queryMode:'local',hiddenName:"val",displayField:'name',valueField:'val',typeAhead:true,minChars:1,forceSelection:true,allowBlank:false},{xtype:'hidden',name:'po_sub_total'},{xtype:'textfield',name:'po_sub_total_text',fieldLabel:'Sub Total',anchor:'100%',width:300,minValue:0,readOnly:true,allowBlank:true,listeners:{change:function(){}}},{xtype:'hidden',name:'po_discount'},{xtype:'textfield',name:'po_discount_text',fieldLabel:'Discount',anchor:'100%',width:300,minValue:0,readOnly:true,allowBlank:true,listeners:{change:function(){}}},{xtype:'numberfield',name:'po_tax',fieldLabel:'Tax',anchor:'100%',width:300,minValue:0,hideTrigger:true,allowDecimals:true,hideTrigger:true,allowBlank:true,listeners:{blur:function(){me.calculate_PO();}}},{xtype:'numberfield',name:'po_shipping',fieldLabel:'Shipping',anchor:'100%',width:300,minValue:0,hideTrigger:true,allowDecimals:true,hideTrigger:true,allowBlank:true,listeners:{blur:function(){me.calculate_PO();}}},{xtype:'hidden',name:'po_total_price'},{xtype:'textfield',name:'po_total_price_text',fieldLabel:'Grand Total',anchor:'100%',width:300,readOnly:true,allowBlank:true},{xtype:'checkbox',name:'is_active',fieldLabel:'Status Active',inputValue:'1',hidden:true},{xtype:'checkbox',name:'approval_status',fieldLabel:'Approval PO',inputValue:'1',value:'1',labelWidth:130},{xtype:'hidden',name:'old_approval_status',}]}]}]},{xtype:'gridpanel',height:238,store:me.store_purchaseOrderDetailTemp,id:'grid_purchaseOrderDetail',selModel:selModel_purchaseOrderDetail,scroll:true,border:1,columns:[{xtype:'gridcolumn',dataIndex:'id',text:'Detail ID',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'po_id',text:'PO ID',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'ro_detail_id',text:'Detail RO ID',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'supplier_item_id',text:'Supply Item ID',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'item_id',text:'Supply ID',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'unit_id',text:'Unit ID',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'po_detail_purchase',text:'po_detail_purchase',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'po_detail_potongan',text:'po_detail_potongan',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'po_detail_total',text:'po_detail_total',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'item_hpp',text:'item_hpp',hidden:true,hideable:false},{xtype:'gridcolumn',dataIndex:'item_code_name',text:'item_code_name',hidden:true,hideable:false},{xtype:'gridcolumn',width:110,dataIndex:'item_code',text:'Kode',sortable:false},{xtype:'gridcolumn',width:150,dataIndex:'item_name',text:'Nama Barang',sortable:false},{xtype:'gridcolumn',width:80,dataIndex:'po_detail_qty',text:'Qty',align:'center',sortable:false},{xtype:'gridcolumn',width:80,dataIndex:'po_receive_qty',text:'di Terima',align:'center',sortable:false},{xtype:'gridcolumn',width:100,dataIndex:'unit_name',text:'Unit',sortable:false},{xtype:'gridcolumn',width:100,dataIndex:'po_detail_purchase_show',text:'Hrg.Beli',align:'right',sortable:false},{xtype:'gridcolumn',width:100,dataIndex:'po_detail_potongan_show',text:'Discount',align:'right',sortable:false},{xtype:'gridcolumn',width:100,dataIndex:'po_detail_total_show',text:'Total',align:'right',sortable:false},{xtype:'gridcolumn',width:100,dataIndex:'po_receive_total_show',text:'Tot.Receive',align:'right',sortable:false},{xtype:'gridcolumn',width:100,dataIndex:'ro_number',text:'RO',sortable:false}],viewConfig:{stripeRows:true,forceFit:true},listeners:{itemdblclick:function(view,rec,item,index,eventObj){var form=Ext.getCmp('form_purchaseOrder').getForm();if(!me.edit_data){}else{if(me.edit_data.po_status=='done'){ExtApp.Msg.warning('Cannot Edit Item, Status PO is Done/Used!');return true;}}
var getSelection=Ext.getCmp('grid_purchaseOrderDetail').getSelectionModel().selected;if(getSelection.length>0){me.formType_Detail='edit';me.edit_data=rec.data;if(me.edit_data.po_detail_status=='request'||me.edit_data.po_detail_status=='new'){me.createWindow(me,'add_purchaseOrderDetail');}else{ExtApp.Msg.info("Item been received");}}}},dockedItems:[{xtype:'toolbar',dock:'top',items:['->',{text:'Add',id:'addButton_purchaseOrderDetail',tooltip:'Add Purchase Order Detail',iconCls:'btn-add',handler:function(){var form=Ext.getCmp('form_purchaseOrder').getForm();me.formType_Detail='add';me.createWindow(me,'add_purchaseOrderDetail');}},'-',{text:'Delete',id:'deleteButton_purchaseOrderDetail',tooltip:'Delete Purchase Order Detail',iconCls:'btn-delete',disabled:true,handler:function(){var getSelection=Ext.getCmp('grid_purchaseOrderDetail').getSelectionModel().selected;if(getSelection.length>0){me.delete_data=getSelection.items[0].data;me.deleteConfirm_purchaseOrderDetail();}else{ExtApp.Msg.info('Please select the data to be deleted!');}}},]}]},{xtype:"component",id:'print_area_purchaseOrder',autoEl:{tag:"iframe",src:url_report},border:false}]}],buttons:[{text:'For Supplier',formBind:true,id:'btnPrint_purchaseOrderQty',iconCls:'btn-print',handler:function(){me.print_purchaseOrder(3);}},{text:'Print',formBind:true,id:'btnPrint_purchaseOrder',iconCls:'btn-print',handler:function(){me.print_purchaseOrder(1);}},{text:'Excel',formBind:true,id:'btnExcel_purchaseOrder',iconCls:'btn-excel',handler:function(){me.print_purchaseOrder(2);}},'->',{text:'Closing PO / Done',formBind:true,id:'btnClosing_purchaseOrder',iconCls:'btn-warning',handler:function(){me.closing_purchaseOrder();}},'',{text:'Save PO',formBind:true,id:'btnSave_purchaseOrder_confirm',iconCls:'btn-save',handler:function(){var form=Ext.getCmp('form_purchaseOrder').getForm();var get_approval_status=form.findField('approval_status').getValue();if(get_approval_status==true){me.Verify_purchaseOrder();}else{if(me.formType=='add'){me.save_purchaseOrder();}else{if(me.approval_change_payment_po_done==1){if(me.edit_data.po_status=='done'){me.Verify_payment_purchaseOrder();}else{me.save_purchaseOrder();}}else{me.save_purchaseOrder();}}}}},{xtype:'button',id:me.id+'_btnSave_purchaseOrder',hidden:true,listeners:{click:function(){me.save_purchaseOrder();}}},{text:'Cancel',iconCls:'btn-cancel',handler:function(){me.doClose(me.id+'_add_purchaseOrder');}}],listeners:{show:function(){var form=Ext.getCmp('form_purchaseOrder').getForm();var po_id=-1;if(me.use_approval_po==1){form.findField('approval_status').show();}else{form.findField('approval_status').hide();}
if(form.findField('form_type_purchaseOrder').getValue()=='add'){form.reset();var myMask=new Ext.LoadMask(Ext.getCmp('purchaseOrder_detailArea'),{msg:"Loading..."});myMask.show();form.findField('is_active').setValue('1');form.findField('po_date').format='d-m-Y';form.findField('po_date').setValue(new Date());form.findField('supplier_name').setDisabled(false);form.findField('supplier_from_ro').setDisabled(false);form.findField('supplier_from_ro').setValue(0);form.findField('old_approval_status').setValue('');form.findField('po_status').setValue('New PO');Ext.getCmp('btnPrint_purchaseOrderQty').setDisabled(true);Ext.getCmp('btnPrint_purchaseOrder').setDisabled(true);Ext.getCmp('btnExcel_purchaseOrder').setDisabled(true);Ext.getCmp('btnClosing_purchaseOrder').setDisabled(true);Ext.getCmp('addButton_purchaseOrderDetail').setDisabled(false);Ext.getCmp('deleteButton_purchaseOrderDetail').setDisabled(false);me.store_purchaseOrderDetailTemp.proxy.extraParams.po_id=po_id;me.store_purchaseOrderDetailTemp.loadData([]);var supplier_from_ro=form.findField('supplier_from_ro').getSubmitValue();if(supplier_from_ro==1){store_ComboboxMasterSupplier_purchaseOrderDetail.proxy.extraParams.validated=1;}else{store_ComboboxMasterSupplier_purchaseOrderDetail.proxy.extraParams.validated=0;}
store_ComboboxMasterSupplier_purchaseOrderDetail.load({callback:function(){form.findField('supplier_id').setValue(0);form.findField('supplier_name').setValue('');}});myMask.hide();}else{form.setValues(me.edit_data);var po_id=me.edit_data.id;if(me.edit_data.supplier_id>0){form.findField('supplier_name').setDisabled(true);form.findField('supplier_from_ro').setDisabled(true);}else{form.findField('supplier_name').setDisabled(false);form.findField('supplier_from_ro').setDisabled(false);store_ComboboxMasterSupplier_purchaseOrderDetail.load();}
Ext.getCmp('btnPrint_purchaseOrderQty').setDisabled(false);Ext.getCmp('btnPrint_purchaseOrder').setDisabled(false);Ext.getCmp('btnExcel_purchaseOrder').setDisabled(false);Ext.getCmp('btnClosing_purchaseOrder').setDisabled(false);var po_sub_total=parseFloat(me.edit_data.po_total_price)+parseFloat(me.edit_data.po_discount)-parseFloat(me.edit_data.po_tax)-parseFloat(me.edit_data.po_shipping);form.findField('po_sub_total').setValue(po_sub_total);form.findField('po_sub_total_text').setValue('Rp '+phpJs.priceFormat(po_sub_total));form.findField('po_total_price_text').setValue('Rp '+phpJs.priceFormat(me.edit_data.po_total_price));var myMask=new Ext.LoadMask(Ext.getCmp('purchaseOrder_detailArea'),{msg:"Loading..."});myMask.show();form.findField('old_approval_status').setValue(me.edit_data.approval_status);Ext.getCmp('addButton_purchaseOrderDetail').setDisabled(false);Ext.getCmp('deleteButton_purchaseOrderDetail').setDisabled(false);if(me.edit_data.po_status=='done'||me.edit_data.used_on_receiving==1){if(me.edit_data.used_on_receiving==1&&me.edit_data.po_status=='progress'){form.findField('po_status').setValue(me.edit_data.po_status+' / used on receiving');}else{Ext.getCmp('addButton_purchaseOrderDetail').setDisabled(true);Ext.getCmp('deleteButton_purchaseOrderDetail').setDisabled(true);}}else{if(me.edit_data.approval_status=='done'){Ext.getCmp('addButton_purchaseOrderDetail').setDisabled(true);Ext.getCmp('deleteButton_purchaseOrderDetail').setDisabled(true);}}
me.store_purchaseOrderDetailTemp.proxy.extraParams.po_id=po_id;me.store_purchaseOrderDetailTemp.proxy.extraParams.limit=99999;me.store_purchaseOrderDetailTemp.load({callback:function(){myMask.hide();var d=me.store_purchaseOrderDetailTemp.getRange(0);var total_detail=0;var total_receive=0;for(var i=0;i<d.length;i++)
{total_detail+=parseFloat(d[i].data.po_detail_total);total_receive+=parseFloat(d[i].data.po_receive_qty);}
if(me.edit_data.po_status!='done'){if(me.edit_data.used_on_receiving==1&&total_receive>0){ExtApp.Msg.warning('Please careful to update PO data<br/>some PO detail/item has been received');}}}});me.calculate_PO();}}}});},add_purchaseOrderDetail:function(me){var theApp=me.app;var desktop=theApp.getDesktop();var Titletext='Add Detail ';if(me.formType_Detail=='edit'){Titletext='Update Detail ';}
me.first_load_masterItemPOAutocomplete=1;var store_masterItemPOAutocomplete=theApp.getStore('store_masterItemPOAutocomplete',false);if(store_masterItemPOAutocomplete==false){store_masterItemPOAutocomplete=theApp.copyStore('master_pos','store_masterSupplierItem','store_masterItemPOAutocomplete');}
store_masterItemPOAutocomplete.proxy.extraParams.supplier_id=0;store_masterItemPOAutocomplete.proxy.extraParams.item_id=0;store_masterItemPOAutocomplete.proxy.extraParams.skip_date=1;store_masterItemPOAutocomplete.proxy.extraParams.limit=999999;store_masterItemPOAutocomplete.proxy.extraParams.is_dropdown=1;store_masterItemPOAutocomplete.proxy.extraParams.from_supplier_item=1;store_masterItemPOAutocomplete.proxy.extraParams.keywords='';var helperGridDetail=theApp.getHelper('Grid');var phpJs=theApp.getHelper('phpJs');return desktop.createWindow({id:me.id+'_add_purchaseOrderDetail',title:Titletext,width:420,height:280,iconCls:'btn-add',animCollapse:false,constrainHeader:true,resizable:false,minimizable:false,maximizable:false,modal:true,border:0,layout:{type:'fit'},items:[{xtype:'form',id:'form_purchaseOrderDetail',border:0,bodyPadding:10,margin:'0 0 0 0',items:[{xtype:'hidden',name:'form_type_purchaseOrderDetail',value:me.formType_Detail},{xtype:'hidden',name:'id'},{xtype:'hidden',name:'po_id',value:me.po_id},{xtype:'hidden',name:'ro_detail_id'},{xtype:'hidden',name:'item_id'},{xtype:'hidden',name:'item_hpp'},{xtype:'hidden',name:'supplier_item_id'},{xtype:'hidden',name:'unit_id'},{xtype:'hidden',name:'po_detail_status'},{xtype:'hidden',name:'ro_number'},{xtype:'hidden',name:'po_receive_qty'},{xtype:'hidden',name:'item_code'},{xtype:'hidden',name:'item_name'},,{xtype:'checkbox',name:'from_supplier_item',fieldLabel:'From Supplier Item?',inputValue:'1',value:'1',labelWidth:130,listeners:{change:function(combo,records,eOpts){var form=Ext.getCmp('form_purchaseOrderDetail').getForm();var from_supplier_item=form.findField('from_supplier_item').getSubmitValue();if(from_supplier_item==1){store_masterItemPOAutocomplete.proxy.extraParams.from_supplier_item=1;}else{store_masterItemPOAutocomplete.proxy.extraParams.from_supplier_item=0;}
if(me.first_load_masterItemPOAutocomplete==1){}else{store_masterItemPOAutocomplete.load({callback:function(){if(me.formType=='add'){form.findField('item_name').setValue('');form.findField('item_id').setValue(0);form.findField('item_hpp').setValue(0);}}});}}}},{xtype:'combobox',name:'item_code_name',fieldLabel:'Items',emptyText:'-(Auto complete)-',width:350,allowBlank:false,store:store_masterItemPOAutocomplete,displayField:'item_code_name',valueField:'id',queryMode:'local',anyMatch:true,listeners:{select:function(combo,records,eOpts){var form2=Ext.getCmp('form_purchaseOrderDetail').getForm();form2.findField('item_id').setValue(records[0].data.item_id);form2.findField('supplier_item_id').setValue(records[0].data.supplier_item_id);form2.findField('item_name').setValue(records[0].data.item_name);form2.findField('item_code').setValue(records[0].data.item_code);form2.findField('item_code_name').setValue(records[0].data.item_code_name);form2.findField('unit_id').setValue(records[0].data.unit_id);form2.findField('unit_name').setValue(records[0].data.unit_name);form2.findField('item_hpp').setValue(records[0].data.item_hpp);form2.findField('po_detail_purchase').setValue(records[0].data.last_in);form2.findField('po_detail_potongan').setValue(0);},specialkey:function(field,e){if(e.getKey()==e.ENTER){var form2=Ext.getCmp('form_purchaseOrderDetail').getForm();form2.findField('po_detail_qty').focus(true);}}}},{xtype:'numberfield',name:'po_detail_qty',fieldLabel:'Qty',width:200,minValue:0,allowDecimals:true,allowBlank:false,hideTrigger:true,keyNavEnabled:false,mouseWheelEnabled:false,listeners:{specialkey:function(field,e){if(e.getKey()==e.ENTER){var form2=Ext.getCmp('form_purchaseOrderDetail').getForm();form2.findField('unit_id').focus(true);}}}},{xtype:'displayfield',name:'unit_name',fieldLabel:'Unit',width:280,value:'-',},{xtype:'numberfield',name:'po_detail_purchase',fieldLabel:'Price',width:280,minValue:0,allowDecimals:true,allowBlank:false,hideTrigger:true,keyNavEnabled:false,mouseWheelEnabled:false,listeners:{specialkey:function(field,e){if(e.getKey()==e.ENTER){form2.findField('po_detail_potongan').focus();}}}},{xtype:'numberfield',name:'po_detail_potongan',fieldLabel:'Total Potongan',width:280,minValue:0,allowDecimals:true,allowBlank:false,hideTrigger:true,keyNavEnabled:false,mouseWheelEnabled:false,listeners:{specialkey:function(field,e){if(e.getKey()==e.ENTER){Ext.getCmp('btnSave_purchaseOrderDetail').focus();}}}}]}],buttons:[{text:'Add',formBind:true,id:'btnSave_purchaseOrderDetail',iconCls:'btn-save',handler:function(){me.add_purchaseOrderDetail();}},{text:'Cancel',iconCls:'btn-cancel',handler:function(){me.doClose(me.id+'_add_purchaseOrderDetail');}}],listeners:{show:function(){var form=Ext.getCmp('form_purchaseOrder').getForm();var form2=Ext.getCmp('form_purchaseOrderDetail').getForm();var po_id=me.po_id;if(me.formType_Detail=='edit'){form2.setValues(me.edit_data);var supplier_id=form.findField('supplier_id').getValue();po_id=me.edit_data.po_id;form2.findField('po_id').setValue(po_id);var myMask=new Ext.LoadMask(Ext.getCmp('form_purchaseOrderDetail'),{msg:"Loading..."});myMask.show();Ext.getCmp('btnSave_purchaseOrderDetail').setText('Update');store_masterItemPOAutocomplete.proxy.extraParams.supplier_id=supplier_id;var from_supplier_item=form2.findField('from_supplier_item').getSubmitValue();store_masterItemPOAutocomplete.proxy.extraParams.from_supplier_item=from_supplier_item;store_masterItemPOAutocomplete.load({callback:function(){myMask.hide();}});Ext.getCmp('btnSave_purchaseOrderDetail').setDisabled(false);if(me.edit_data.po_status=='done'||me.edit_data.used_on_receiving==1){Ext.getCmp('btnSave_purchaseOrderDetail').setDisabled(true);}}else{var supplier_id=form.findField('supplier_id').getValue();me.reset_purchaseOrderDetail();var myMask=new Ext.LoadMask(Ext.getCmp('form_purchaseOrderDetail'),{msg:"Loading..."});myMask.show();store_masterItemPOAutocomplete.proxy.extraParams.supplier_id=supplier_id;store_masterItemPOAutocomplete.proxy.extraParams.from_supplier_item=1;form2.findField('from_supplier_item').setValue(1);store_masterItemPOAutocomplete.load({callback:function(){myMask.hide();me.first_load_masterItemPOAutocomplete=0;}});}}}});}});