/**
 * Filename: sync_backup.controller.syncBackup.js
 * Generated 2018-09-04 at 08:58:02 PM
 */
Ext.define('ExtApp.modules.sync_backup.controller.syncBackup',{extend:'ExtApp.core.Module',id:'modules.sync_backup.syncBackup',isloadModuleStore:true,suspendIfLoadStore:true,generate_total_data:0,generate_current_total:0,generate_current_loop_total:0,init:function(){this.launcher={text:'Sync & Backup',iconCls:'icon-sync'};},useHelper:[],ModuleStore:{},ModuleModel:{},createWindow:function(me,winID,winFunc){var me=this;var win_func='openWindow';if(winFunc){win_func=winFunc;}
var win_id=me.id;if(winID){win_id=me.id+'_'+winID;if(!winFunc){win_func=winID;}}
var desktop=me.app.getDesktop();var win=me.app.getDesktop().getWindow(win_id);if(!win){me.app.createView('ExtApp.modules.sync_backup.view.syncBackup',me,win_func);}else{me.app.desktop.restoreWindow(win);}},doClose:function(winVar){var me=this;var win=me.app.getDesktop().getWindow(winVar);if(win){win.doClose();}},doSyncFromServer:function(){var me=this;Ext.getCmp('btnSave_syncBackup').setDisabled(true);Ext.getCmp('btnSave2_syncBackup').setDisabled(true);Ext.getCmp('update_info_syncBackup').hide();Ext.getCmp('update_info_error_syncBackup').hide();var myMask=new Ext.LoadMask(Ext.getCmp('form_syncBackup'),{msg:"Syncronize Data - Load Server Info..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Syncronize Data - Load Server Info...',url:appUrl+'sync_backup/syncData/storeInfo?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);myMask.hide();if(rsp.success){if(rsp.is_connected==1){var myMask2=new Ext.LoadMask(Ext.getCmp('form_syncBackup'),{msg:"Syncronize Data - Checking Data Server..."});myMask2.show();Ext.Ajax.request({waitMsg:'Syncronize Data - Checking Data Server...',url:appUrl+'sync_backup/syncData/syncDetail?_dc='+d.getTime(),method:'POST',params:{client_id:rsp.store_connected_id,},success:function(response,options){var rsp=Ext.decode(response.responseText);myMask2.hide();if(rsp.success){me.generate_total_data=rsp.totalCount;me.generate_current_total=0;me.generate_current_loop_total=0;var postData=rsp;me.doDownloadSyncFromServer(postData);}else{Ext.getCmp('update_info_error_syncBackup').setValue(rsp.info);Ext.getCmp('update_info_error_syncBackup').show();Ext.getCmp('update_info_syncBackup').hide();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
Ext.getCmp('update_info_error_syncBackup').setValue('Checking Data Server - Failed!<br/>'+rsp.info);Ext.getCmp('update_info_error_syncBackup').show();Ext.getCmp('update_info_syncBackup').hide();myMask2.hide();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}});}else{Ext.getCmp('update_info_error_syncBackup').setValue('Connect to Server - Failed!<br/>');Ext.getCmp('update_info_error_syncBackup').show();Ext.getCmp('update_info_syncBackup').hide();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}}else{Ext.getCmp('update_info_error_syncBackup').setValue(rsp.info);Ext.getCmp('update_info_error_syncBackup').show();Ext.getCmp('update_info_syncBackup').hide();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
myMask.hide();Ext.getCmp('update_info_error_syncBackup').setValue('Connect to Server - Failed!<br/>'+rsp.info);Ext.getCmp('update_info_error_syncBackup').show();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}});},doDownloadSyncFromServer:function(postData){var me=this;Ext.getCmp('btnSave_syncBackup').setDisabled(true);Ext.getCmp('btnSave2_syncBackup').setDisabled(true);if(me.generate_current_total==0){me.generate_current_total=1;}
var allSyncNo=[];var syncName='';for(x in postData.data){allSyncNo.push(postData.data[x].id);if(me.generate_current_total==postData.data[x].id){syncName=postData.data[x].sync_data_text;}}
var myMask3=new Ext.LoadMask(Ext.getCmp('form_syncBackup'),{msg:"Syncronizing: "+syncName+"..."});myMask3.show();Ext.Ajax.request({waitMsg:'Syncronizing...',url:appUrl+'sync_backup/syncData/generate',method:'POST',params:{client_id:postData.client_id,total_data:me.generate_total_data,current_total:me.generate_current_total,sync_data:Ext.JSON.encode(allSyncNo),sync_type:'client'},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);myMask3.hide();me.generate_total_data=0;me.generate_current_total=0;Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);return false;}else{myMask3.hide();me.generate_current_total+=1;if(me.generate_total_data<me.generate_current_total){me.generate_current_total=0;me.generate_total_data=0;Ext.getCmp('update_info_syncBackup').setValue("Syncronize Data Selesai..");Ext.getCmp('update_info_syncBackup').show();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}else{Ext.getCmp('update_info_syncBackup').setValue(rsp.info);Ext.getCmp('update_info_syncBackup').show();me.doDownloadSyncFromServer(postData);}}},failure:function(response,options){var rsp=Ext.decode(response.responseText);Ext.getCmp('update_info_error_syncBackup').setValue(rsp.info);Ext.getCmp('update_info_error_syncBackup').show();myMask3.hide();me.generate_total_data=0;me.generate_current_total=0;Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}});},doBackupToServer:function(){var me=this;Ext.getCmp('btnSave_syncBackup').setDisabled(true);Ext.getCmp('btnSave2_syncBackup').setDisabled(true);Ext.getCmp('update_info_syncBackup').hide();Ext.getCmp('update_info_error_syncBackup').hide();var myMask=new Ext.LoadMask(Ext.getCmp('form_syncBackup'),{msg:"Backup Data - Load Server Info..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Backup Data - Load Server Info...',url:appUrl+'sync_backup/backupTrx/storeInfo?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);myMask.hide();if(rsp.success){if(rsp.is_connected==1){var myMask2=new Ext.LoadMask(Ext.getCmp('form_syncBackup'),{msg:"Backup Data - Checking Data Server..."});myMask2.show();Ext.Ajax.request({waitMsg:'Backup Data - Checking Data Server...',url:appUrl+'sync_backup/backupTrx/backupDetail?_dc='+d.getTime(),method:'POST',params:{client_id:rsp.store_connected_id,only_backup:'sales'},success:function(response,options){var rsp=Ext.decode(response.responseText);myMask2.hide();if(rsp.success){me.generate_total_data=rsp.totalCount;me.generate_current_total=0;me.generate_current_loop_total=0;var postData=rsp;me.doUploadBackupToServer(postData);}else{Ext.getCmp('update_info_error_syncBackup').setValue(rsp.info);Ext.getCmp('update_info_error_syncBackup').show();Ext.getCmp('update_info_syncBackup').hide();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
Ext.getCmp('update_info_error_syncBackup').setValue('Checking Data Server - Failed!<br/>'+rsp.info);Ext.getCmp('update_info_error_syncBackup').show();Ext.getCmp('update_info_syncBackup').hide();myMask2.hide();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}});}else{Ext.getCmp('update_info_error_syncBackup').setValue('Connect to Server - Failed!<br/>');Ext.getCmp('update_info_error_syncBackup').show();Ext.getCmp('update_info_syncBackup').hide();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}}else{Ext.getCmp('update_info_error_syncBackup').setValue(rsp.info);Ext.getCmp('update_info_error_syncBackup').show();Ext.getCmp('update_info_syncBackup').hide();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
myMask.hide();Ext.getCmp('update_info_error_syncBackup').setValue('Connect to Server - Failed!<br/>'+rsp.info);Ext.getCmp('update_info_error_syncBackup').show();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}});},doUploadBackupToServer:function(postData){var me=this;Ext.getCmp('btnSave_syncBackup').setDisabled(true);Ext.getCmp('btnSave2_syncBackup').setDisabled(true);if(me.generate_current_total==0){me.generate_current_total=1;postData.total_data_on_backup=0;postData.total_data_store=0;postData.last_id_store=0;postData.last_id_on_backup=0;}
var allBackupNo=[];var backupName='';for(x in postData.data){allBackupNo.push(postData.data[x].id);if(me.generate_current_total==postData.data[x].id){backupName=postData.data[x].backup_data_text;postData.total_data_on_backup=postData.data[x].total_data_on_backup;postData.total_data_store=postData.data[x].total_data_store;postData.last_id_store=postData.data[x].last_id_store;postData.last_id_on_backup=postData.data[x].last_id_on_backup;}}
if(me.generate_current_loop_total==0){me.generate_current_loop_total=1;var myMask3=new Ext.LoadMask(Ext.getCmp('form_syncBackup'),{msg:"Backup "+backupName+" Data: dari #"+postData.total_data_on_backup+" s/d #"+postData.last_id_store});myMask3.show();me.last_id_on_backup=postData.last_id_on_backup;me.total_data_on_backup=postData.total_data_on_backup;me.backup_process_name='Sales';}else{var myMask3=new Ext.LoadMask(Ext.getCmp('form_syncBackup'),{msg:"Sedang Proses Backup Data "+backupName+" s/d #"+postData.last_id_store});myMask3.show();}
Ext.Ajax.request({waitMsg:'Backup Transaksi...',url:appUrl+'sync_backup/backupTrx/generate',method:'POST',params:{client_id:postData.client_id,total_data:me.generate_total_data,current_total:me.generate_current_total,last_id_on_backup:me.last_id_on_backup,total_data_on_backup:me.total_data_on_backup,backup_data:Ext.JSON.encode(allBackupNo),backup_type:'client'},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);myMask3.hide();me.generate_total_data=0;me.generate_current_total=0;me.generate_current_loop_total=0;Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);return false;}else{myMask3.hide();if(rsp.has_next==1){me.generate_current_loop_total+=1;me.last_id_on_backup=rsp.last_id_on_backup;me.total_data_on_backup=rsp.total_data_on_backup;postData.total_data_on_backup=rsp.total_data_on_backup;postData.total_data_store=rsp.total_data_store;postData.last_id_store=rsp.last_id_store;Ext.getCmp('update_info_syncBackup').setValue(rsp.info);Ext.getCmp('update_info_syncBackup').show();me.doUploadBackupToServer(postData);}else{me.generate_current_total+=1;me.generate_current_loop_total+=1;if(me.generate_total_data<me.generate_current_total){me.generate_current_total=0;me.generate_current_loop_total=0;me.generate_total_data=0;Ext.getCmp('update_info_syncBackup').setValue("Backup Data Selesai..");Ext.getCmp('update_info_syncBackup').show();Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}else{Ext.getCmp('update_info_syncBackup').setValue("Backup Data "+backupName+" s/d #"+postData.last_id_store+" - Selesai..");Ext.getCmp('update_info_syncBackup').show();me.doUploadBackupToServer(postData);}}}},failure:function(response,options){var rsp=Ext.decode(response.responseText);Ext.getCmp('update_info_error_syncBackup').setValue(rsp.info);Ext.getCmp('update_info_error_syncBackup').show();myMask3.hide();me.generate_total_data=0;me.generate_current_total=0;me.generate_current_loop_total=0;Ext.getCmp('btnSave_syncBackup').setDisabled(false);Ext.getCmp('btnSave2_syncBackup').setDisabled(false);}});}});