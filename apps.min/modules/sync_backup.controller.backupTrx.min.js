/**
 * Filename: sync_backup.controller.backupTrx.js
 * Generated 2019-04-19 at 09:55:51 AM
 */
Ext.define('ExtApp.modules.sync_backup.controller.backupTrx',{extend:'ExtApp.core.Module',id:'modules.sync_backup.backupTrx',isloadModuleStore:true,suspendIfLoadStore:true,generate_total_data:0,generate_current_total:0,generate_current_loop_total:0,init:function(){this.launcher={text:'Backup Transaksi',iconCls:'icon-backup'};},useHelper:[],ModuleStore:{'sync_backup':[{store_name:'store_backupTrx',autoload:false},{store_name:'store_backupTrxDetail',autoload:false},{store_name:'store_backupTrxLog',autoload:false}],'systems':[]},ModuleModel:{'sync_backup':[{model_name:'model_backupTrx'},{model_name:'model_backupTrxDetail'},{model_name:'model_backupTrxLog'}],'systems':[]},createWindow:function(me,winID,winFunc){var me=this;var win_func='openWindow';if(winFunc){win_func=winFunc;}
var win_id=me.id;if(winID){win_id=me.id+'_'+winID;if(!winFunc){win_func=winID;}}
var desktop=me.app.getDesktop();var win=me.app.getDesktop().getWindow(win_id);if(!win){me.app.createView('ExtApp.modules.sync_backup.view.backupTrx',me,win_func);}else{me.app.desktop.restoreWindow(win);}},doClose:function(winVar){var me=this;var win=me.app.getDesktop().getWindow(winVar);if(win){win.doClose();}},generateConfirm_backupTrx:function(){var me=this;var getSelection=Ext.getCmp('grid_backupTrxDetail').getSelectionModel().selected;var selected_data={allId:[],allVar:[],allName:'',client_id:0,client_name:'',client_code:'',client_email:'',last_id_on_backup:[],total_data_on_backup:[],nama_module:[]};var noDt=0;for(x in getSelection.items){noDt++;selected_data.allId.push(getSelection.items[x].data.id);selected_data.allVar.push(getSelection.items[x].data.backup_data);selected_data.last_id_on_backup.push(getSelection.items[x].data.last_id_on_backup);selected_data.total_data_on_backup.push(getSelection.items[x].data.total_data_on_backup);selected_data.nama_module.push(getSelection.items[x].data.backup_data_text);if(selected_data.allName==''){selected_data.allName=getSelection.items[x].data.backup_data_text;}else{selected_data.allName+=', '+getSelection.items[x].data.backup_data_text;}}
selected_data.client_id=Ext.getCmp('client_id_backupTrx').getValue();selected_data.client_name=Ext.getCmp('client_name_backupTrx').getValue();selected_data.client_code=Ext.getCmp('client_code_backupTrx').getValue();selected_data.client_email=Ext.getCmp('client_email_backupTrx').getValue();ExtApp.Msg.confirm('Backup Transaksi <br/><i>'+selected_data.allName+'?</i>',false,function(btn){if(btn=='yes'){me.generate_total_data=0;me.generate_current_total=0;me.generate_current_loop_total=0;me.generateStop_backupTrx=false;Ext.getCmp('generateButton_backupTrx').hide();Ext.getCmp('stopButton_backupTrx').show();me.generateCheck_backupTrx(selected_data);}else{return false;}});},generateCheck_backupTrx:function(selected_data){var me=this;var theApp=me.app;if(!selected_data.allId){ExtApp.Msg.info("Data undefined!");return;}
me.generate_total_data=selected_data.allId.length;Ext.getCmp('displayProgres_backupTrx').setValue('Backup Process..');me.generateAction_backupTrx(selected_data);},generateAction_backupTrx:function(selected_data){var me=this;var theApp=me.app;if(!selected_data.allId){Ext.getCmp('generateButton_backupTrx').show();Ext.getCmp('stopButton_backupTrx').hide();ExtApp.Msg.info("Data Tidak Dikenali!");return false;}
if(me.generate_total_data==0){Ext.getCmp('generateButton_backupTrx').show();Ext.getCmp('stopButton_backupTrx').hide();ExtApp.Msg.info("Silahkan Pilih Data!");return false;}
if(me.generate_current_total==0){me.generate_current_total=1;}
if(me.generate_current_loop_total==0){me.generate_current_loop_total=1;me.last_id_on_backup=selected_data.last_id_on_backup[me.generate_current_total-1];me.total_data_on_backup=selected_data.total_data_on_backup[me.generate_current_total-1];me.backup_process_name=selected_data.nama_module[me.generate_current_total-1];}
Ext.getCmp('generateButton_backupTrx').hide();Ext.getCmp('stopButton_backupTrx').show();var phpJs=theApp.getHelper('phpJs');var myMask=new Ext.LoadMask(Ext.getCmp('grid_backupTrxDetail'),{msg:"Backup Process: "+me.backup_process_name+" - Data #"+me.last_id_on_backup+"..."});myMask.show();Ext.Ajax.request({waitMsg:'Backup Transaksi...',url:appUrl+'sync_backup/backupTrx/generate',method:'POST',params:{client_id:selected_data.client_id,client_code:selected_data.client_code,client_name:selected_data.client_name,client_email:selected_data.client_email,total_data:me.generate_total_data,current_total:me.generate_current_total,last_id_on_backup:me.last_id_on_backup,total_data_on_backup:me.total_data_on_backup,backup_data_id:Ext.JSON.encode(selected_data.allId),backup_data:Ext.JSON.encode(selected_data.allVar),backup_type:'client'},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);myMask.hide();me.generate_total_data=0;me.generate_current_total=0;me.generate_current_loop_total=0;if(me.generateStop_backupTrx==true){Ext.getCmp('generateButton_backupTrx').show();Ext.getCmp('stopButton_backupTrx').hide();Ext.getCmp('displayProgres_backupTrx').setValue(rsp.info+',  Generate Backup - Stopped!');Ext.getCmp('grid_backupTrxDetail').store.load();me.generateStop_backupTrx=false;return false;}
return false;}else{Ext.getCmp('displayProgres_backupTrx').setValue(rsp.info);myMask.hide();if(rsp.has_next==1){me.generate_current_loop_total+=1;me.last_id_on_backup=rsp.last_id_on_backup;me.total_data_on_backup=rsp.total_data_on_backup;Ext.getCmp('displayProgres_backupTrx').setValue(rsp.info);if(me.generateStop_backupTrx==true){Ext.getCmp('generateButton_backupTrx').show();Ext.getCmp('stopButton_backupTrx').hide();Ext.getCmp('displayProgres_backupTrx').setValue(rsp.info+', Generate Backup - Stopped!');Ext.getCmp('grid_backupTrxDetail').store.load();return false;}
me.generateAction_backupTrx(selected_data);}else{me.generate_current_total+=1;me.generate_current_loop_total=0;if(me.generateStop_backupTrx==true){Ext.getCmp('generateButton_backupTrx').show();Ext.getCmp('stopButton_backupTrx').hide();Ext.getCmp('displayProgres_backupTrx').setValue(rsp.info+', Generate Backup - Stopped!');Ext.getCmp('grid_backupTrxDetail').store.load();me.generateStop_backupTrx=false;return false;}
if(me.generate_total_data<me.generate_current_total){me.generate_current_total=0;me.generate_current_loop_total=0;me.generate_total_data=0;Ext.getCmp('displayProgres_backupTrx').setValue(rsp.info);Ext.getCmp('grid_backupTrxDetail').store.load();Ext.getCmp('generateButton_backupTrx').show();Ext.getCmp('stopButton_backupTrx').hide();}else{Ext.getCmp('displayProgres_backupTrx').setValue(rsp.info);me.generateAction_backupTrx(selected_data);}}}},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();me.generate_total_data=0;me.generate_current_total=0;me.generate_current_loop_total=0;me.generateStop_backupTrx=false;Ext.getCmp('generateButton_backupTrx').show();Ext.getCmp('stopButton_backupTrx').hide();}});},reset_backupTrxDetail:function(){var me=this;var theApp=me.app;var phpJs=theApp.getHelper('phpJs');var store_backupTrx=Ext.getCmp('grid_backupTrx').store;var store_backupTrxDetail=Ext.getCmp('grid_backupTrxDetail').store;store_backupTrx.proxy.extraParams.client_id=0;store_backupTrx.proxy.extraParams.client_code='';store_backupTrx.proxy.extraParams.client_name='';store_backupTrx.proxy.extraParams.client_email='';store_backupTrxDetail.proxy.extraParams.client_id=0;store_backupTrxDetail.proxy.extraParams.client_code='';store_backupTrxDetail.proxy.extraParams.client_name='';store_backupTrxDetail.proxy.extraParams.client_email='';store_backupTrx.loadData([]);store_backupTrxDetail.loadData([]);},search_backupTrx:function(){var me=this;var theApp=me.app;var store_backupTrx=Ext.getCmp('grid_backupTrx').store;var store_backupTrxDetail=Ext.getCmp('grid_backupTrxDetail').store;store_backupTrx.loadData([]);var phpJs=theApp.getHelper('phpJs');var myMask=new Ext.LoadMask(Ext.getCmp('grid_backupTrx'),{msg:"Connecting to Server..."});myMask.show();Ext.Ajax.request({waitMsg:'Connecting ...',url:appUrl+'sync_backup/backupTrx/storeInfo',method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);myMask.hide();return false;}else{store_backupTrx.loadData(rsp.data);myMask.hide();Ext.getCmp('client_id_backupTrx').setValue(rsp.store_connected_id);Ext.getCmp('client_code_backupTrx').setValue(rsp.store_connected_code);Ext.getCmp('client_name_backupTrx').setValue(rsp.store_connected_name);Ext.getCmp('client_email_backupTrx').setValue(rsp.store_connected_email);store_backupTrxDetail.proxy.extraParams.client_id=rsp.store_connected_id;store_backupTrxDetail.proxy.extraParams.client_code=rsp.store_connected_code;store_backupTrxDetail.proxy.extraParams.client_name=rsp.store_connected_name;store_backupTrxDetail.proxy.extraParams.client_email=rsp.store_connected_email;store_backupTrxDetail.load();Ext.getCmp('grid_backupTrxDetail').getSelectionModel().deselectAll();}},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);}});}});